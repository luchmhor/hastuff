= PV Battery Optimization Documentation
:toc: left
:icons: font
:source-highlighter: highlightjs

== Overview

This Home Assistant automation manages a battery/inverter system (e.g., APsystems EZHI) to optimize self-consumption. It operates primarily in **"Grid Follow"** mode, dynamically adjusting inverter output to zero-out grid import/export.

It includes safety layers for **SOC protection**, **PV curtailment prevention**, and **Economic optimization** (suppressing feed-in during cheap pricing hours).

== Logic Decision Tree

The automation evaluates rules sequentially. The first condition met stops the execution flow for that run.

[mermaid]
....
graph TD
    Start([Start Automation]) --> CheckRule2{Rule 2: <br/>Suppress Feed-in?}
    
    %% Rule 2
    CheckRule2 -- Yes --> Action2[Set Output to 0W]
    Action2 --> End([End])
    CheckRule2 -- No --> CheckRule4A{Rule 4: <br/>PV Curtailment Risk?}

    %% Rule 4 (Curtailment)
    CheckRule4A -- Yes --> Action4A[Increase Output <br/>(Dump Energy)]
    Action4A --> End
    CheckRule4A -- No --> CheckRule4B{Rule 4: <br/>Battery Full & Discharging?}

    %% Rule 4 (Full Optimization)
    CheckRule4B -- Yes --> Action4B[Decrease Output <br/>(Stop Discharge)]
    Action4B --> End
    CheckRule4B -- No --> CheckRule5{Rule 5: <br/>SOC Protection?}

    %% Rule 5 (SOC Low)
    CheckRule5 -- Yes --> Action5[Set Output to 0W]
    Action5 --> End
    CheckRule5 -- No --> DefaultLogic{Grid Status?}

    %% Default Logic (Grid Follow)
    DefaultLogic -- "Import > 10W" --> GridFollowImport[Increase Output <br/>to match Load]
    DefaultLogic -- "Export < -10W" --> GridFollowExport[Decrease Output <br/>to stop Export]
    DefaultLogic -- "Deadzone (-10W to 10W)" --> GridBalanced[Do Nothing]
    
    GridFollowImport --> End
    GridFollowExport --> End
    GridBalanced --> End
....

== Configuration Constants

The following constants are defined in the `variables` section of the automation. These control the thresholds and physical limits of the system.

[cols="2,1,4", options="header"]
|===
| Constant Name | Value | Description

| `output_min_limit`
| -1200
| The minimum integer value for the inverter control. (If bidirectional hardware, this allows charging).

| `output_max_limit`
| 1200
| The maximum physical output of the inverter in Watts.

| `battery_full_threshold`
| 98
| Battery percentage (%) considered "Full". Triggers curtailment prevention logic.

| `min_soc_discharge_limit`
| 12
| Minimum SOC (%) allowed. Below this, the inverter is forced to 0W to prevent blackout/damage.

| `grid_power_deadzone`
| 10
| Hysteresis buffer in Watts. If grid power is within +/- 10W, no adjustments are made.

| `grid_power_threshold`
| 50
| Threshold in Watts to determine step size. Above 50W uses high step factor; below uses low step factor.

| `step_factor_high`
| 1.0
| PID Aggressiveness: When import is high, correct by 100% of the measured grid power.

| `step_factor_low`
| 0.5
| PID Aggressiveness: When import is low, correct by 50% to prevent oscillation.

| `grid_follow_min_step`
| 10
| Minimum adjustment step in Watts. Prevents micro-adjustments that wear out hardware.

| `suppress_price_percentile`
| 40
| Economic threshold. Feed-in is suppressed if the current price is in the bottom 40% of the day's prices.

| `suppress_feed_in_max_soc`
| 92
| SOC Override for suppression. If battery > 92%, we ignore price suppression to ensure the battery can capture new solar.

| `pv_curtailment_power_threshold`
| 100
| Watts. If battery charging power exceeds this while full, trigger curtailment prevention.

| `pv_curtailment_increase_factor`
| 1.2
| Factor. Multiply current battery charging power by 1.2 to calculate the new increased output target.

| `pv_curtailment_min_increase_step`
| 50
| Watts. Minimum amount to increase output during a curtailment event.

| `battery_full_discharge_threshold`
| -10
| Watts. If battery discharge is "more negative" than -10W while full, output is reduced.

| `battery_full_decrease_factor`
| 0.8
| Factor. Multiply discharge power by 0.8 to calculate output reduction.

| `battery_full_min_decrease_step`
| 20
| Watts. Minimum amount to reduce output when balancing a full battery.
|===

== Detailed Rule Definitions

=== Rule 2: Suppress Grid Feed-in (Cheap Price Window)
**Purpose:** Prevents discharging the battery into the grid when electricity prices are low (or negative). It preserves battery cycles for expensive hours.

* **Conditions:**
** `current_price` is within the cheapest `40%` of today's prices.
** `battery_soc` is less than `92%` (If the battery is nearly full, this rule is skipped to allow burning off excess solar).
* **Action:**
** Sets `inverter_output_control` to **0**.

=== Rule 4: PV Curtailment Prevention
**Purpose:** If the battery is full (98%+) and the solar panels are producing more energy than the house needs, the inverter increases AC output to the grid. This prevents the MPPT charger from throttling (curtailing) solar production.

* **Conditions:**
** `battery_soc` >= 98%.
** `battery_power` > 10W (Charging).
** `inverter_output_control` is not yet at max limit.
** Rule 2 (Suppress Feed-in) is NOT active.
* **Action:**
** Calculates `new_output` = `current_output` + (`battery_power` * 1.2).
** Sets inverter to `new_output`.

=== Rule 4 (Variant): Battery Full Optimization
**Purpose:** Prevents "micro-cycling" at the top. If the battery is full but momentarily discharges (e.g., cloud passes), reduce output slightly to keep the battery topped up.

* **Conditions:**
** `battery_soc` >= 98%.
** `battery_power` < -10W (Discharging).
* **Action:**
** Reduces `inverter_output_control` slightly to lower the discharge rate.

=== Rule 5: SOC Protection
**Purpose:** The "Low Battery" cutoff. Prevents the battery from discharging below the set reserve.

* **Conditions:**
** `battery_soc` <= 12%.
** `inverter_output_control` < 0 (Discharging/Exporting).
* **Action:**
** Sets `inverter_output_control` to **0**.

=== Rule 1: Grid Follow (Default)
**Purpose:** The standard operating mode. It attempts to keep `grid_power` at 0W (Zero Export/Zero Import).

**Scenario A: High Import (> 10W)**
* **Logic:** The house is drawing power from the grid.
* **Action:** Increases inverter output.
** If import > 50W: Increases by 100% of the deficit.
** If import < 50W: Increases by 50% of the deficit (dampening).

**Scenario B: High Export (< -10W)**
* **Logic:** The inverter is outputting too much, sending power to the grid.
* **Action:** Decreases inverter output.
** Logic applies same dampening factors as import.

**Scenario C: Balanced (-10W to 10W)**
* **Logic:** The system is within the "Deadzone".
* **Action:** No changes sent to the inverter to prevent network congestion and wear.

== Required Entities

The automation relies on the following mappings:

[cols="1,2"]
|===
| Variable | Entity ID

| `grid_power`
| `sensor.shrdzm_485519e15aae_16_7_0`

| `battery_soc`
| `sensor.ezhi_battery_state_of_charge`

| `battery_power`
| `sensor.ezhi_battery_power`

| `inverter_output_control`
| `number.apsystems_ezhi_max_output_power`

| `price_data`
| `sensor.epex_spot_data_gross_price`

| `active_rule`
| `input_text.solar_battery_active_rule`

| `status_message`
| `input_text.solar_battery_status_message`
|===
